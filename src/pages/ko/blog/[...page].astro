---
import type { GetStaticPaths, Page } from 'astro';
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import PostCard from '../../../components/blog/PostCard.astro';
import Layout from '../../../layouts/Layout.astro';

interface Props {
  page: Page<CollectionEntry<'blog'>>;
}

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  // Get all Korean blog posts from Content Collections
  const allPosts = await getCollection('blog', ({ data }) => {
    return data.lang === 'ko' && !data.isDraft;
  });

  // Sort posts by publication date (newest first)
  const sortedPosts = allPosts.sort(
    (a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
  );

  // Paginate with 12 posts per page
  return paginate(sortedPosts, { pageSize: 12 });
};

const { page } = Astro.props;
const pageTitle = '기술 블로그 | Cor.inc';
const pageDescription = 'AI/머신러닝, 소프트웨어 엔지니어링, 창업 여정 및 혁신을 다루는 최신 기술 블로그. 개발자와 엔지니어를 위한 실용적인 통찰과 지식.';

// Categories for filtering
const categories = [
  { id: 'all', label: '전체' },
  { id: 'ai', label: 'AI' },
  { id: 'engineering', label: '엔지니어링' },
  { id: 'founder', label: '창업자' },
  { id: 'lab', label: '연구소' },
];
---

<Layout title={pageTitle} description={pageDescription}>
  <div class="mx-auto max-w-7xl px-4 py-16 sm:px-6 lg:px-8">
    <!-- Page Header -->
    <div class="mb-12 text-center">
      <h1 class="mb-4 text-4xl font-bold text-stone-900 dark:text-stone-100 sm:text-5xl">
        블로그
      </h1>
      <p class="mx-auto max-w-2xl text-lg text-stone-600 dark:text-stone-300">
        {pageDescription}
      </p>

      <!-- RSS Feed Link -->
      <div class="mt-4">
        <a
          href="/ko/rss.xml"
          class="inline-flex items-center gap-2 text-sm text-stone-500 hover:text-stone-700 dark:text-stone-400 dark:hover:text-stone-200 transition-colors"
          title="RSS 피드 구독"
        >
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path d="M5 3a1 1 0 000 2c5.523 0 10 4.477 10 10a1 1 0 102 0C17 8.373 11.627 3 5 3z"/>
            <path d="M4 9a1 1 0 011-1 7 7 0 017 7 1 1 0 11-2 0 5 5 0 00-5-5 1 1 0 01-1-1zM3 15a2 2 0 114 0 2 2 0 01-4 0z"/>
          </svg>
          RSS 피드
        </a>
      </div>

      <!-- Pagination Info -->
      {page.total > page.size && (
        <p class="mt-4 text-sm text-stone-500 dark:text-stone-400">
          표시 중 {page.start + 1}-{page.end} / 총 {page.total}개 글 (페이지 {page.currentPage}/{page.lastPage})
        </p>
      )}
    </div>

    <!-- Category Filter -->
    <div class="mb-8 flex flex-wrap justify-center gap-2">
      {categories.map(category => (
        <a
          href={category.id === 'all' ? '/ko/blog' : `/ko/blog/category/${category.id}`}
          class="rounded-full px-4 py-2 text-sm font-medium border-2 transition-all duration-200 bg-white text-black border-gray-300 hover:bg-gray-50 dark:bg-black dark:text-white dark:border-gray-600 dark:hover:bg-gray-900"
        >
          {category.label}
        </a>
      ))}
    </div>

    <!-- Blog Posts Grid -->
    {page.data.length > 0 ? (
      <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
        {page.data.map(post => (
          <PostCard post={post} />
        ))}
      </div>
    ) : (
      <div class="text-center py-12">
        <p class="text-lg text-stone-600 dark:text-stone-300">
          아직 블로그 글이 없습니다
        </p>
      </div>
    )}

    <!-- Pagination Controls -->
    {page.total > page.size && (
      <div class="mt-12 flex justify-center gap-2">
        {page.url.prev && (
          <a
            href={page.url.prev}
            class="rounded-lg px-4 py-2 text-sm font-medium text-stone-700 hover:bg-stone-100 dark:text-stone-300 dark:hover:bg-stone-800"
          >
            ← 이전
          </a>
        )}

        <span class="px-4 py-2 text-sm text-stone-600 dark:text-stone-400">
          {page.currentPage} / {page.lastPage} 페이지
        </span>

        {page.url.next && (
          <a
            href={page.url.next}
            class="rounded-lg px-4 py-2 text-sm font-medium text-stone-700 hover:bg-stone-100 dark:text-stone-300 dark:hover:bg-stone-800"
          >
            다음 →
          </a>
        )}
      </div>
    )}
  </div>
</Layout>