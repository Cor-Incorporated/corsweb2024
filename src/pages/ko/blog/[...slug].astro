---
import { type CollectionEntry, getCollection } from 'astro:content';
import CategoryBadge from '../../../components/blog/CategoryBadge.astro';
import PostCard from '../../../components/blog/PostCard.astro';
import ShareButtons from '../../../components/blog/ShareButtons.astro';
import TableOfContents from '../../../components/blog/TableOfContents.astro';
import TipButton from '../../../components/blog/TipButton.astro';
import BlogLayout from '../../../layouts/BlogLayout.astro';
import { getCurrentLocale } from '../../../utils/i18n';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => {
    return data.lang === 'ko' && !data.isDraft;
  });

  return posts.map((post) => ({
    params: { slug: post.slug.replace('ko/', '') },
    props: { post },
  }));
}

interface Props { post: CollectionEntry<'blog'> }

const { post } = Astro.props;
const { Content, headings } = await post.render();
const currentLocale = getCurrentLocale(Astro.url);

// Get related posts and navigation posts
const allPosts = await getCollection('blog', ({ data }) => {
  return data.lang === 'ko' && !data.isDraft;
});

const sortedPosts = allPosts.sort(
  (a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
);

const currentIndex = sortedPosts.findIndex(p => p.slug === post.slug);
const relatedPosts = allPosts
  .filter(p => p.slug !== post.slug && p.data.category === post.data.category)
  .slice(0, 3);

const nextPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : undefined;
const prevPost = currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : undefined;

const formattedPubDate = new Date(post.data.pubDate).toLocaleDateString('ko-KR', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const formattedUpdatedDate = post.data.updatedDate ? new Date(post.data.updatedDate).toLocaleDateString('ko-KR', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
}) : null;

// Calculate reading time based on content length
const readingTime = Math.max(1, Math.round(post.body.length / 1000));
const fullUrl = new URL(Astro.url.pathname, Astro.site).toString();

---

<BlogLayout post={post} relatedPosts={relatedPosts} nextPost={nextPost} prevPost={prevPost}>
  <article class="mx-auto max-w-4xl px-4 py-16 sm:px-6 lg:px-8">
    <!-- Breadcrumb -->
    <nav class="mb-8" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-2 text-sm text-stone-600 dark:text-stone-400">
        <li><a href="/ko" class="hover:text-blue-600 dark:hover:text-blue-400">홈</a></li>
        <li class="before:content-['/'] before:mx-2"><a href="/ko/blog" class="hover:text-blue-600 dark:hover:text-blue-400">블로그</a></li>
        <li class="before:content-['/'] before:mx-2"><span class="text-stone-900 dark:text-stone-100">{post.data.title}</span></li>
      </ol>
    </nav>

    <!-- Header -->
    <header class="mb-8">
      <div class="mb-4 flex items-center gap-4 text-sm">
        <CategoryBadge category={post.data.category} />
        <time datetime={post.data.pubDate.toISOString()} class="text-stone-500 dark:text-stone-400">{formattedPubDate}</time>
        <span class="text-stone-500 dark:text-stone-400">{readingTime}분 소요</span>
      </div>
      <h1 class="mb-4 text-4xl font-bold text-stone-900 dark:text-stone-100 sm:text-5xl">{post.data.title}</h1>
      <p class="mb-6 text-lg text-stone-600 dark:text-stone-300">{post.data.description}</p>
      <div class="flex items-center justify-between border-b border-stone-200 pb-6 dark:border-stone-700">
        <div class="text-sm font-medium text-stone-900 dark:text-stone-100">{post.data.author}</div>
        <ShareButtons title={post.data.title} url={fullUrl} />
      </div>
    </header>

    {post.data.image && (
      <div class="mb-8 overflow-hidden rounded-2xl">
        <img src={post.data.image.url} alt={post.data.image.alt} class="h-auto w-full" loading="eager" decoding="async" />
      </div>
    )}

    {headings.length > 3 && <div class="mb-8"><TableOfContents headings={headings} /></div>}

    <div class="prose prose-lg prose-stone mx-auto dark:prose-invert">
      <Content />
    </div>

    <div class="mx-auto mt-12 max-w-3xl"><TipButton /></div>

    <!-- Tags -->
    {post.data.tags.length > 0 && (
      <div class="mt-12 border-t border-stone-200 pt-8 dark:border-stone-700">
        <h3 class="mb-4 text-sm font-medium uppercase tracking-wider text-stone-500 dark:text-stone-400">
          태그
        </h3>
        <div class="flex flex-wrap gap-2">
          {post.data.tags.map(tag => (
            <a
              href={`/ko/blog/tags/${tag}`}
              class="rounded-full bg-stone-100 px-3 py-1 text-sm font-medium text-stone-600 transition-colors hover:bg-stone-200 dark:bg-stone-700 dark:text-stone-300 dark:hover:bg-stone-600"
            >
              #{tag}
            </a>
          ))}
        </div>
      </div>
    )}

    <!-- Navigation -->
    <nav class="mt-12 grid gap-4 border-t border-stone-200 pt-8 dark:border-stone-700 sm:grid-cols-2">
      {prevPost && (
        <a
          href={`/ko/blog/${prevPost.slug.replace('ko/', '')}`}
          class="group flex flex-col rounded-lg border border-stone-200 p-4 transition-colors hover:border-blue-600 dark:border-stone-700 dark:hover:border-blue-400"
        >
          <span class="mb-1 text-sm text-stone-500 dark:text-stone-400">
            ← 이전 글
          </span>
          <span class="font-medium text-stone-900 group-hover:text-blue-600 dark:text-stone-100 dark:group-hover:text-blue-400">
            {prevPost.data.title}
          </span>
        </a>
      )}
      
      {nextPost && (
        <a
          href={`/ko/blog/${nextPost.slug.replace('ko/', '')}`}
          class={`group flex flex-col rounded-lg border border-stone-200 p-4 text-right transition-colors hover:border-blue-600 dark:border-stone-700 dark:hover:border-blue-400 ${!prevPost ? 'sm:col-start-2' : ''}`}
        >
          <span class="mb-1 text-sm text-stone-500 dark:text-stone-400">
            다음 글 →
          </span>
          <span class="font-medium text-stone-900 group-hover:text-blue-600 dark:text-stone-100 dark:group-hover:text-blue-400">
            {nextPost.data.title}
          </span>
        </a>
      )}
    </nav>

    <!-- Updated Date -->
    {formattedUpdatedDate && (
      <div class="mt-8 text-sm text-stone-500 dark:text-stone-400">
        마지막 업데이트: {formattedUpdatedDate}
      </div>
    )}

    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <div class="mt-12 border-t border-stone-200 pt-8 dark:border-stone-700">
        <h2 class="mb-6 text-2xl font-bold text-stone-900 dark:text-stone-100">관련 글</h2>
        <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
          {relatedPosts.map(relPost => (
            <PostCard post={relPost} />
          ))}
        </div>
      </div>
    )}
  </article>
</BlogLayout>